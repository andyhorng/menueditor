<link rel="import" href="components/polymer/polymer.html">
<link rel="import" href="components/paper-styles/paper-styles.html">
<link rel="import" href="components/iron-ajax/iron-ajax.html">
<link rel="import" href="components/iron-form/iron-form.html">
<link rel="import" href="components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="components/paper-input/paper-input.html">
<link rel="import" href="components/paper-button/paper-button.html">
<link rel="import" href="components/paper-dialog/paper-dialog.html">

<dom-module id="menu-form">

<style>

.item paper-input {
  display: inline-block;
  margin-left: 1em;
  margin-right: 1em;
}

.item .del {
  color: var(--paper-red-500);
}

</style>

<template>
  <iron-ajax id="menuResource" url="{{url}}" handle-as="json" last-response="{{menu}}"></iron-ajax>
  <paper-dialog id="delDialog">
    <p>Are you sure?</p>
    <div class="buttons">
      <paper-button dialog-dismiss>Cancel</paper-button>
      <paper-button on-tap="del" dialog-confirm autofocus>OK</paper-button>
    </div>
  </paper-dialog>

  <form is="iron-form" id="menuForm">
    <paper-toolbar>
      <div class="title">{{menu.name}}</div>
      <paper-icon-button icon="done" on-tap="submit"></paper-icon-button>
      <paper-icon-button icon="delete" on-tap="openDel"></paper-icon-button>
    </paper-toolbar>

    <div>

      <div>
        <paper-input name="name" label="Name" value="[[menu.name]]" required></paper-input>
        <paper-input name="address" label="Address" value="[[menu.address]]" required></paper-input>
      </div>

      <paper-material elevation="2">
        <template id="menuItems" is="dom-repeat" items="{{menu.items}}" on-dom-change="itemsUpdated">
          <div class="item">
            <paper-input label="Item Name" value="{{item.name}}" required></paper-input>
            <paper-input label="Item Price" value="{{item.price}}" required></paper-input>
            <paper-icon-button class="del" on-tap="removeItem" icon="clear" alt="clear"></paper-button>
            </div>
            <!-- <paper-input label="Price" value="[[item.price]]" required></paper-input> -->
          </template>
          <paper-button class="add" on-tap="addItem" raised>Add</paper-button>
        </div>

      </paper-material>


    </form>

  </template>

  <script>
  Polymer({
    is: 'menu-form',
    ready: function() {
      this.url = "/api/menu/" + this.menuid;
    },
    properties: {
      menuid: {
        type: String,
        notify: true,
        observer: '_menuidChanged'
      },
      menu: {
        type: Object,
        notify: true,
      }
    },
    _menuidChanged: function (value, oldValue) {
      this.url = "/api/menu/" + value;
      this.$.menuResource.generateRequest();
    },
    submit: function (e) {
      // this.$.menuForm.submit();
      var json = this.$.menuForm.serialize();
      json.items = this.$.menuItems.items;

      var request = new XMLHttpRequest();
      request.open('PATCH', this.url, json);
      request.setRequestHeader('Content-Type', 'application/json');
      request.send(JSON.stringify(json));
    },
    openDel: function(e) {
      this.$.delDialog.open();
    },
    del: function (e) {
      var request = new XMLHttpRequest();
      request.open('DELETE', this.url);
      request.setRequestHeader('Content-Type', 'application/json');
      request.send();
      // TODO: callback on request success
      fire = function() {
        this.fire('deleted', this.menu);
      }
      window.setTimeout(fire.bind(this), 1000);
    },
    addItem: function (e) {
      this.push('menu.items', {});
    },
    removeItem: function (e) {
      this.splice('menu.items', e.model.index, 1);
    },
    itemsUpdated: function (e) {
      var items = Polymer.dom(this.root).querySelectorAll(".item");
      var last = items[items.length-1];
      this.async(function () {
        if (!last) {
          return;
        }
        last.querySelector("paper-input").inputElement.focus();
      });
    }
  });
  </script>

</dom-module>
